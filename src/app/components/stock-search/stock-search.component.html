<section id="search-section">
  <div class="container mt-5 d-md-flex flex-column justify-content-center">
    <div class="d-md-flex justify-content-center mb-2">
      <h1>STOCK SEARCH</h1>
    </div>
    <div class="d-md-flex justify-content-center container-md">
      <div class="input-group mb-3 search-bar row">
        <input matInput type="text" [formControl]="stockSearchControl"
               class="form-control me-2 border-0 no-outline col-md-10"
               placeholder="Enter stock ticker symbol" aria-label="Stock ticker symbol" [matAutocomplete]="auto"
               (keydown.enter)="searchStock(stockSearchControl.value)"> <!-- Updated this line -->
        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
          <ng-container *ngFor="let option of autocompleteSearchResults">
            <mat-option [value]="option.displaySymbol"
                        (click)="searchStock(stockSearchControl.value)">{{ option.displaySymbol + " | " + option.description }}
            </mat-option>
          </ng-container>
        </mat-autocomplete>
        <div class="input-group-append d-flex col-md-2">
          <button class="btn no-outline" type="button" (click)="searchStock(stockSearchControl.value)">
            <i class="bi bi-search"></i>
          </button>
          <button class="btn border-0" type="button" (click)="clearSearch()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
    </div>

  </div>
  <div *ngIf="errorMessage" class="container-sm">
    <ngb-alert type='danger' [hidden]="!errorMessage">No data found for the search results</ngb-alert>
  </div>
  <div class="container" *ngIf="showSpinner || showSpinnerSearch">
    <div class="text-center">
      <mat-spinner diameter="75" style="margin: 0 auto;"></mat-spinner>
    </div>
  </div>
</section>
<div #searchPageContents class="container-sm my-4">
  <div *ngIf="(currentTab == 'Summary') then companyInfo">
  </div>
  <div id="common-company-info-section">
    <ng-template #companyInfo>
      <ngb-alert type='success' [hidden]="!portfolioBoughtAlertMessageBoolean">{{ portfolioBoughtAlertMessage }}
      </ngb-alert>
      <ngb-alert type='danger' [hidden]="!portfolioAlertSoldMessageBoolean">{{ tickerSymbol }} sold successfully
      </ngb-alert>
      <ngb-alert type='success' [hidden]="!wishlistAlertMessageAddedBoolean">{{ tickerSymbol }} added to wishlist
      </ngb-alert>
      <ngb-alert type='danger' [hidden]="!wishlistAlertMessageRemovedBoolean">{{ tickerSymbol }} removed from wishlist
      </ngb-alert>
      <div class="container-sm">
        <div class="d-sm-flex justify-content-sm-evenly company-info-card fs-5">
          <div>
            <div>
              <div class="p-1">
                {{ stockProfile?.ticker }}
                <i [ngClass]="{'bi bi-star': !isFavorite, 'bi bi-star-fill text-warning': isFavorite}"
                   class="favorite-icon"
                   (click)="toggleFavorite()"></i>
              </div>
              <div class="p-1">{{ stockProfile?.name }}</div>
              <div class="p-1 fs-6">{{ stockProfile?.exchange }}</div>
              <div class="d-md-flex flex-row justify-content-center p-1">
                <button class="btn btn-success p-2 m-2 w-25" (click)="buyStock(stockPortfolioData)">Buy</button>
                <button class="btn btn-danger p-2 m-2 w-25" *ngIf="stockPortfolioData?.quantity > 0"
                        (click)="sellStock(stockPortfolioData)">Sell
                </button>
              </div>
            </div>
          </div>
          <div>
            <div class="text-center p-1">
              <img class="stock-company-logo" [src]="stockProfile?.logo">
            </div>
            <div class="text-center p-1">
              <div *ngIf="getMarketStatus()" class="text-danger ">Market Closed
                on {{ latestPrice?.t * 1000 | date: 'medium' }}
              </div>
              <div *ngIf="!getMarketStatus()" class="text-success">Market is Open</div>
            </div>
          </div>
          <div>
            <div class="p-1 stock-body">
              <div class="p-1"
                   [ngClass]="{'negative': !getProfitOrLossCP(), 'positive': getProfitOrLossCP()}">{{ latestPrice?.c }}
              </div>
              <div>
                <i class="p-1"
                   [ngClass]="{'negative bi bi-caret-down-fill': !getProfitOrLossCP(), 'bi bi-caret-up-fill positive': getProfitOrLossCP()}">
                </i>
                <div class="p-1"
                     [ngClass]="{'negative': !getProfitOrLossCP(), 'positive': getProfitOrLossCP()}">{{ latestPrice?.d }}
                  ({{ latestPrice?.dp | number:'1.0-2' }}%)
                </div>
              </div>
              <div class="p-1 fs-6">{{ Date() }}</div>
            </div>
          </div>
        </div>
        <div>
          <mat-tab-group [(selectedIndex)]="selectedIndex" (selectedIndexChange)="selectTab($event)">
            <mat-tab label="Summary"></mat-tab>
            <mat-tab label="Top News"></mat-tab>
            <mat-tab label="Charts"></mat-tab>
            <mat-tab label="Insights"></mat-tab>
          </mat-tab-group>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="getTemplate()"></ng-container>
    </ng-template>
  </div>
  <div id="company-summary-section">
    <ng-template #summaryTab>
      <div class="container-md d-md-flex">
        <div class="row-cols-6">
          <div class="w-100">
            <div>
              <div class="text-center m-2">
                <div>High Price : {{ latestPrice?.h }}</div>
                <div>Low Price: {{ latestPrice?.l }}</div>
                <div>Open Price: {{ latestPrice?.o }}</div>
                <div>Prev. Close: {{ latestPrice?.pc }}</div>
              </div>
            </div>
            <div>
              <div>
                <p><strong>About the company</strong></p>
              </div>
              <div>
                <p><strong>IPO Start Date: </strong>{{ stockProfile?.ipo }}</p>
                <p><strong>Industry: </strong>{{ stockProfile?.finnhubIndustry }}</p>
                <p><strong>Webpage: </strong><a href="{{stockProfile?.weburl}}">{{ stockProfile?.weburl }}</a></p>
                <p><strong>Company Peers: </strong></p>
                <div class="company-peers-container">
              <span *ngFor="let company of companyPeers; let isLast=last">
                    <a href="#"
                       (click)="searchStock(company); $event.preventDefault()">{{ company }}</a>
              </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row-cols-6 w-100">
          <div class="w-100 text-center">
            <highcharts-chart
              [Highcharts]="Highcharts"
              [options]="chartOptionsSummary"
              style="width: 100%; height: 400px; display: inline;">
            </highcharts-chart>
          </div>
        </div>
      </div>
    </ng-template>
  </div>
  <div id="company-news-section">
    <div class="container-sm">
      <ng-template #newsTab>
        <div class="row">
          <div *ngFor="let newsOption of newsResponse; let i = index" class="col-md-6 mb-2 mt-2">
            <mat-card class="m-1 bg-light" (click)="openDialog(newsOption)">
              <mat-card-content class="d-flex container">
                <div class="row w-100">
                  <div class="col-4 d-flex justify-content-center">
                    <img mat-card-sm-image [src]="newsOption?.image" [alt]="newsOption?.related">
                  </div>
                  <div class="col-8 d-flex justify-content-center">
                    <p>{{ newsOption?.headline }}</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
            <div *ngIf="(i + 1) % 2 === 0" class="w-100 d-none d-md-block"></div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
  <div id="company-charts-section">
    <ng-template #chartsTab>
      <highcharts-chart
        [Highcharts]="Highcharts"
        [options]="chartOptions"
        [constructorType]="'stockChart'"
        style="width: 100%; height: 700px; display: block"
      ></highcharts-chart>
    </ng-template>
  </div>
  <div id="company-insights-section">
    <ng-template #insightsTab>
      <div class="container-sm mt-3">
        <div>
          <div>
            <div class="text-center">
              <h3>Insider Sentiments</h3>
            </div>
            <div class="container-sm text-center w-50">
              <table mat-table [dataSource]="aggregateSentimentTable" class="table table-hover"
                     *ngIf="aggregateSentimentTable">

                <ng-container matColumnDef="field">
                  <th mat-header-cell *matHeaderCellDef>{{ tickerSymbol }}</th>
                  <td mat-cell *matCellDef="let element" class="fw-semibold">{{ element.field }}</td>
                </ng-container>

                <ng-container matColumnDef="mspr">
                  <th mat-header-cell *matHeaderCellDef>MSPR</th>
                  <td mat-cell *matCellDef="let element">{{ element.mspr | number:'1.0-2' }}</td>
                </ng-container>

                <ng-container matColumnDef="change">
                  <th mat-header-cell *matHeaderCellDef>Change</th>
                  <td mat-cell *matCellDef="let element">{{ element.change }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['field', 'mspr', 'change']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['field', 'mspr', 'change']"></tr>

              </table>
            </div>
          </div>
        </div>
        <div class="container-sm d-sm-flex">
          <highcharts-chart
            [Highcharts]="Highcharts"
            [options]="insightsRecommendationChartOptions"
            style="width: 50%; height: 400px; display: inline;"
            class="m-2"
          ></highcharts-chart>
          <highcharts-chart
            [Highcharts]="Highcharts"
            [options]="insightsSurpriseChartOptions"
            style="width: 50%; height: 400px; display: inline"
            class="m-2"
          ></highcharts-chart>
        </div>
      </div>

    </ng-template>
  </div>
</div>
